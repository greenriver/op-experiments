  [1m[35m (23.6ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" character varying NOT NULL PRIMARY KEY)[0m
  [1m[35m (5.8ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" character varying NOT NULL PRIMARY KEY, "value" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.6ms)[0m  [1m[34mSELECT pg_try_advisory_lock(4031604989078678130)[0m
  [1m[36mActiveRecord::SchemaMigration Pluck (1.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
Migrating to CreateWorkflowStates (20220124194724)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (10.3ms)[0m  [1m[35mCREATE TABLE "workflow_states" ("id" bigserial primary key, "label" character varying, "workflow_id" bigint, "details_type" character varying, "details_id" bigint, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (51.0ms)[0m  [1m[35mCREATE INDEX "index_workflow_states_on_workflow_id" ON "workflow_states" ("workflow_id")[0m
  [1m[35m (0.7ms)[0m  [1m[35mCREATE INDEX "index_workflow_states_on_details" ON "workflow_states" ("details_type", "details_id")[0m
  [1m[35m (0.7ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_workflow_states_on_label_and_workflow_id" ON "workflow_states" ("label", "workflow_id")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.4ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ($1) RETURNING "version"[0m  [["version", "20220124194724"]]
  [1m[36mTRANSACTION (1.7ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateWorkflowTransitions (20220124194835)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (8.4ms)[0m  [1m[35mCREATE TABLE "workflow_transitions" ("id" bigserial primary key, "workflow_id" bigint, "label" character varying, "guard" character varying, "source_state_id" bigint NOT NULL, "destination_state_id" bigint NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, CONSTRAINT "fk_rails_65cad411b9"
FOREIGN KEY ("source_state_id")
  REFERENCES "workflow_states" ("id")
, CONSTRAINT "fk_rails_bc0fc163c6"
FOREIGN KEY ("destination_state_id")
  REFERENCES "workflow_states" ("id")
)[0m
  [1m[35m (0.7ms)[0m  [1m[35mCREATE INDEX "index_workflow_transitions_on_workflow_id" ON "workflow_transitions" ("workflow_id")[0m
  [1m[35m (0.6ms)[0m  [1m[35mCREATE INDEX "index_workflow_transitions_on_source_state_id" ON "workflow_transitions" ("source_state_id")[0m
  [1m[35m (0.6ms)[0m  [1m[35mCREATE INDEX "index_workflow_transitions_on_destination_state_id" ON "workflow_transitions" ("destination_state_id")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ($1) RETURNING "version"[0m  [["version", "20220124194835"]]
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateWorkflows (20220124194955)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.0ms)[0m  [1m[35mCREATE TABLE "workflows" ("id" bigserial primary key, "initial_state_id" bigint NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, CONSTRAINT "fk_rails_e3fad0d986"
FOREIGN KEY ("initial_state_id")
  REFERENCES "workflow_states" ("id")
)[0m
  [1m[35m (0.8ms)[0m  [1m[35mCREATE INDEX "index_workflows_on_initial_state_id" ON "workflows" ("initial_state_id")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ($1) RETURNING "version"[0m  [["version", "20220124194955"]]
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateWorkflowInstances (20220124195041)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.4ms)[0m  [1m[35mCREATE TABLE "workflow_instances" ("id" bigserial primary key, "workflow_id" bigint NOT NULL, "state" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.7ms)[0m  [1m[35mCREATE INDEX "index_workflow_instances_on_workflow_id" ON "workflow_instances" ("workflow_id")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ($1) RETURNING "version"[0m  [["version", "20220124195041"]]
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.3ms)[0m  [1m[34mSELECT "ar_internal_metadata".* FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 LIMIT $2[0m  [["key", "environment"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[36mActiveRecord::InternalMetadata Create (0.7ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ($1, $2, $3, $4) RETURNING "key"[0m  [["key", "environment"], ["value", "test"], ["created_at", "2022-01-24 19:59:03.282076"], ["updated_at", "2022-01-24 19:59:03.282076"]]
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_advisory_unlock(4031604989078678130)[0m
  [1m[36mActiveRecord::SchemaMigration Pluck (0.5ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Pluck (0.5ms)[0m  [1m[34mSELECT "ar_internal_metadata"."value" FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 LIMIT $2[0m  [["key", "schema_sha1"], ["LIMIT", 1]]
  [1m[36mActiveRecord::SchemaMigration Pluck (0.4ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Pluck (0.2ms)[0m  [1m[34mSELECT "ar_internal_metadata"."value" FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 LIMIT $2[0m  [["key", "environment"], ["LIMIT", 1]]
  [1m[36mActiveRecord::SchemaMigration Pluck (0.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Pluck (0.2ms)[0m  [1m[34mSELECT "ar_internal_metadata"."value" FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 LIMIT $2[0m  [["key", "environment"], ["LIMIT", 1]]
  [1m[36mActiveRecord::SchemaMigration Pluck (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Pluck (0.1ms)[0m  [1m[34mSELECT "ar_internal_metadata"."value" FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 LIMIT $2[0m  [["key", "environment"], ["LIMIT", 1]]
  [1m[35m (31.9ms)[0m  [1m[35mDROP DATABASE IF EXISTS "dbfsm_test"[0m
  [1m[35m (167.0ms)[0m  [1m[35mCREATE DATABASE "dbfsm_test" ENCODING = 'unicode'[0m
  [1m[35mSQL (1.1ms)[0m  [1m[35mCREATE EXTENSION IF NOT EXISTS "plpgsql"[0m
  [1m[35m (0.4ms)[0m  [1m[35mDROP TABLE IF EXISTS "workflow_instances" CASCADE[0m
  [1m[35m (9.0ms)[0m  [1m[35mCREATE TABLE "workflow_instances" ("id" bigserial primary key, "workflow_id" bigint NOT NULL, "state" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.6ms)[0m  [1m[35mCREATE INDEX "index_workflow_instances_on_workflow_id" ON "workflow_instances" ("workflow_id")[0m
  [1m[35m (0.2ms)[0m  [1m[35mDROP TABLE IF EXISTS "workflow_states" CASCADE[0m
  [1m[35m (4.5ms)[0m  [1m[35mCREATE TABLE "workflow_states" ("id" bigserial primary key, "label" character varying, "workflow_id" bigint, "details_type" character varying, "details_id" bigint, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.9ms)[0m  [1m[35mCREATE INDEX "index_workflow_states_on_details" ON "workflow_states" ("details_type", "details_id")[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_workflow_states_on_label_and_workflow_id" ON "workflow_states" ("label", "workflow_id")[0m
  [1m[35m (1.3ms)[0m  [1m[35mCREATE INDEX "index_workflow_states_on_workflow_id" ON "workflow_states" ("workflow_id")[0m
  [1m[35m (0.2ms)[0m  [1m[35mDROP TABLE IF EXISTS "workflow_transitions" CASCADE[0m
  [1m[35m (4.1ms)[0m  [1m[35mCREATE TABLE "workflow_transitions" ("id" bigserial primary key, "workflow_id" bigint, "label" character varying, "guard" character varying, "source_state_id" bigint NOT NULL, "destination_state_id" bigint NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_workflow_transitions_on_destination_state_id" ON "workflow_transitions" ("destination_state_id")[0m
  [1m[35m (1.4ms)[0m  [1m[35mCREATE INDEX "index_workflow_transitions_on_source_state_id" ON "workflow_transitions" ("source_state_id")[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_workflow_transitions_on_workflow_id" ON "workflow_transitions" ("workflow_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "workflows" CASCADE[0m
  [1m[35m (2.1ms)[0m  [1m[35mCREATE TABLE "workflows" ("id" bigserial primary key, "initial_state_id" bigint NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_workflows_on_initial_state_id" ON "workflows" ("initial_state_id")[0m
  [1m[35m (5.9ms)[0m  [1m[35mALTER TABLE "workflow_transitions" ADD CONSTRAINT "fk_rails_bc0fc163c6"
FOREIGN KEY ("destination_state_id")
  REFERENCES "workflow_states" ("id")
[0m
  [1m[35m (1.2ms)[0m  [1m[35mALTER TABLE "workflow_transitions" ADD CONSTRAINT "fk_rails_65cad411b9"
FOREIGN KEY ("source_state_id")
  REFERENCES "workflow_states" ("id")
[0m
  [1m[35m (1.2ms)[0m  [1m[35mALTER TABLE "workflows" ADD CONSTRAINT "fk_rails_e3fad0d986"
FOREIGN KEY ("initial_state_id")
  REFERENCES "workflow_states" ("id")
[0m
  [1m[35m (3.4ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" character varying NOT NULL PRIMARY KEY)[0m
  [1m[36mActiveRecord::SchemaMigration Pluck (0.5ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (0.6ms)[0m  [1m[32mINSERT INTO "schema_migrations" (version) VALUES (20220124195041)[0m
  [1m[35m (0.4ms)[0m  [1m[32mINSERT INTO "schema_migrations" (version) VALUES
(20220124194724),
(20220124194835),
(20220124194955);

[0m
  [1m[35m (3.0ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" character varying NOT NULL PRIMARY KEY, "value" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.3ms)[0m  [1m[34mSELECT "ar_internal_metadata".* FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 LIMIT $2[0m  [["key", "environment"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mActiveRecord::InternalMetadata Create (0.5ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ($1, $2, $3, $4) RETURNING "key"[0m  [["key", "environment"], ["value", "test"], ["created_at", "2022-01-24 20:04:34.267402"], ["updated_at", "2022-01-24 20:04:34.267402"]]
  [1m[36mTRANSACTION (2.6ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.3ms)[0m  [1m[34mSELECT "ar_internal_metadata".* FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 LIMIT $2[0m  [["key", "environment"], ["LIMIT", 1]]
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT "ar_internal_metadata".* FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 LIMIT $2[0m  [["key", "schema_sha1"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[36mActiveRecord::InternalMetadata Create (0.2ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ($1, $2, $3, $4) RETURNING "key"[0m  [["key", "schema_sha1"], ["value", "e57c7a81f89112bdb433ec7dc20d00809a7a2b97"], ["created_at", "2022-01-24 20:04:34.276094"], ["updated_at", "2022-01-24 20:04:34.276094"]]
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mActiveRecord::SchemaMigration Pluck (0.7ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (0.4ms)[0m  [1m[35mALTER TABLE "workflow_instances" DISABLE TRIGGER ALL;ALTER TABLE "ar_internal_metadata" DISABLE TRIGGER ALL;ALTER TABLE "workflow_states" DISABLE TRIGGER ALL;ALTER TABLE "workflow_transitions" DISABLE TRIGGER ALL;ALTER TABLE "workflows" DISABLE TRIGGER ALL;ALTER TABLE "schema_migrations" DISABLE TRIGGER ALL[0m
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (1.8ms)[0m  [1m[31mDELETE FROM "workflow_instances";
DELETE FROM "workflow_states";
DELETE FROM "workflow_transitions";
DELETE FROM "workflows";
INSERT INTO "workflow_states" ("id", "label", "workflow_id", "details_type", "details_id", "created_at", "updated_at") VALUES (1042750897, 'initial', 24853765, DEFAULT, DEFAULT, '2022-01-24 20:04:34.396720', '2022-01-24 20:04:34.396720'), (752180425, 'final', 24853765, DEFAULT, DEFAULT, '2022-01-24 20:04:34.396720', '2022-01-24 20:04:34.396720');
INSERT INTO "workflow_transitions" ("id", "workflow_id", "label", "source_state_id", "destination_state_id", "created_at", "updated_at") VALUES (443223901, 24853765, 'trigger', 1042750897, 752180425, '2022-01-24 20:04:34.402902', '2022-01-24 20:04:34.402902');
INSERT INTO "workflows" ("id", "initial_state_id", "created_at", "updated_at") VALUES (24853765, 1042750897, '2022-01-24 20:04:34.405311', '2022-01-24 20:04:34.405311')[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (0.8ms)[0m  [1m[35mALTER TABLE "workflow_instances" ENABLE TRIGGER ALL;ALTER TABLE "ar_internal_metadata" ENABLE TRIGGER ALL;ALTER TABLE "workflow_states" ENABLE TRIGGER ALL;ALTER TABLE "workflow_transitions" ENABLE TRIGGER ALL;ALTER TABLE "workflows" ENABLE TRIGGER ALL;ALTER TABLE "schema_migrations" ENABLE TRIGGER ALL[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (23.3ms)[0m  [1m[35mdo $$
  declare r record;
BEGIN
FOR r IN (
  SELECT FORMAT(
    'UPDATE pg_constraint SET convalidated=false WHERE conname = ''%I''; ALTER TABLE %I VALIDATE CONSTRAINT %I;',
    constraint_name,
    table_name,
    constraint_name
  ) AS constraint_check
  FROM information_schema.table_constraints WHERE constraint_type = 'FOREIGN KEY'
)
  LOOP
    EXECUTE (r.constraint_check);
  END LOOP;
END;
$$;
[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
-----------------------------------------------
WorkflowInstanceTest: test_simple_state_machine
-----------------------------------------------
  [1m[36mWorkflow Load (0.1ms)[0m  [1m[34mSELECT "workflows".* FROM "workflows" WHERE "workflows"."id" = $1 LIMIT $2[0m  [["id", 24853765], ["LIMIT", 1]]
  [1m[36mCACHE Workflow Load (0.0ms)[0m  [1m[34mSELECT "workflows".* FROM "workflows" WHERE "workflows"."id" = $1 LIMIT $2[0m  [["id", 24853765], ["LIMIT", 1]]
  [1m[36mWorkflowState Load (0.2ms)[0m  [1m[34mSELECT "workflow_states".* FROM "workflow_states" WHERE "workflow_states"."id" = $1 LIMIT $2[0m  [["id", 1042750897], ["LIMIT", 1]]
  [1m[36mWorkflowTransition Load (0.2ms)[0m  [1m[34mSELECT "workflow_transitions".* FROM "workflow_transitions" WHERE "workflow_transitions"."workflow_id" = $1[0m  [["workflow_id", 24853765]]
  [1m[36mCACHE WorkflowState Load (0.0ms)[0m  [1m[34mSELECT "workflow_states".* FROM "workflow_states" WHERE "workflow_states"."id" = $1 LIMIT $2[0m  [["id", 1042750897], ["LIMIT", 1]]
  [1m[36mWorkflowState Load (0.2ms)[0m  [1m[34mSELECT "workflow_states".* FROM "workflow_states" WHERE "workflow_states"."id" = $1 LIMIT $2[0m  [["id", 752180425], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mWorkflowInstance Create (0.4ms)[0m  [1m[32mINSERT INTO "workflow_instances" ("workflow_id", "state", "created_at", "updated_at") VALUES ($1, $2, $3, $4) RETURNING "id"[0m  [["workflow_id", 24853765], ["state", "final"], ["created_at", "2022-01-24 20:04:34.485021"], ["updated_at", "2022-01-24 20:04:34.485021"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mWorkflowInstance Pluck (0.2ms)[0m  [1m[34mSELECT "workflow_instances"."state" FROM "workflow_instances"[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK[0m
